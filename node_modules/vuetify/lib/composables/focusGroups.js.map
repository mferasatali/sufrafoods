{"version":3,"file":"focusGroups.js","names":["toValue","focusableChildren","useFocusGroups","_ref","groups","onLeave","getContentRef","group","type","contentRef","value","$el","getChildren","onTabKeydown","e","target","direction","shiftKey","children","map","currentGroupIndex","g","findIndex","el","contains","nextIndex","nextFocusGroup","originGroup","origin","isListGroup","atEdge","at","preventDefault","stopImmediatePropagation","nextGroup","displayItemsCount","focus","fromBefore","currentIndex","isAtEdge","step","i","length"],"sources":["../../src/composables/focusGroups.ts"],"sourcesContent":["// Utilities\nimport { toValue } from 'vue'\nimport { focusableChildren } from '@/util'\n\n// Types\nimport type { MaybeRefOrGetter, Ref } from 'vue'\nimport type { VList } from '@/components/VList'\n\ntype FocusGroup =\n  | { type: 'list', contentRef: Ref<VList | undefined>, displayItemsCount: MaybeRefOrGetter<number> }\n  | { type: 'element', contentRef: Ref<HTMLElement | undefined> }\n\nexport function useFocusGroups ({ groups, onLeave }: {\n  groups: FocusGroup[]\n  onLeave: () => void\n}) {\n  function getContentRef (group: FocusGroup): HTMLElement | undefined {\n    return group.type === 'list'\n      ? group.contentRef.value?.$el as HTMLElement | undefined\n      : group.contentRef.value\n  }\n\n  function getChildren (group: FocusGroup): HTMLElement[] {\n    const contentRef = getContentRef(group)\n    return contentRef ? focusableChildren(contentRef) : []\n  }\n\n  function onTabKeydown (e: KeyboardEvent) {\n    const target = e.target as Element\n    const direction = e.shiftKey ? 'backward' : 'forward'\n    const children = groups.map(getChildren)\n\n    const currentGroupIndex = groups\n      .map(g => g.type === 'list' ? g.contentRef.value?.$el as HTMLElement : g.contentRef.value)\n      .findIndex(el => el?.contains(target))\n\n    const nextIndex = nextFocusGroup(children, currentGroupIndex, direction, target)\n\n    if (nextIndex === null) {\n      const originGroup = groups[currentGroupIndex]\n      const origin = children[currentGroupIndex]\n      const isListGroup = originGroup.type === 'list'\n\n      const atEdge = isListGroup || (\n        direction === 'forward'\n          ? origin.at(-1) === e.target\n          : origin.at(0) === e.target\n      )\n\n      if (atEdge) {\n        onLeave()\n      }\n    } else {\n      e.preventDefault()\n      e.stopImmediatePropagation()\n\n      const nextGroup = groups[nextIndex]\n      if (nextGroup.type === 'list' && toValue(nextGroup.displayItemsCount) > 0) {\n        nextGroup.contentRef.value?.focus(0)\n      } else {\n        const fromBefore = direction === 'forward'\n        children[nextIndex].at(fromBefore ? 0 : -1)!.focus()\n      }\n    }\n  }\n\n  function nextFocusGroup (\n    children: HTMLElement[][],\n    currentIndex: number,\n    direction: 'forward' | 'backward',\n    target: Element\n  ): number | null {\n    const originGroup = groups[currentIndex]\n    const origin = children[currentIndex]\n\n    // List groups always allow leaving (VList manages internal focus)\n    // Element groups require being at the edge focusable child\n    if (originGroup.type !== 'list') {\n      const isAtEdge = direction === 'forward'\n        ? origin.at(-1) === target\n        : origin.at(0) === target\n\n      if (!isAtEdge) return null\n    }\n\n    const step = direction === 'forward' ? 1 : -1\n    for (let i = currentIndex + step; i >= 0 && i < groups.length; i += step) {\n      const group = groups[i]\n      if (children[i].length > 0 || (group.type === 'list' && toValue(group.displayItemsCount) > 0)) {\n        return i\n      }\n    }\n\n    return null\n  }\n\n  return { onTabKeydown }\n}\n"],"mappings":"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","ignoreList":[]}